<!DOCTYPE html>
<html>
<head>
  <title>Talksy Mini ðŸ’¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family:'Segoe UI', sans-serif; background:linear-gradient(to right, #87CEFA, #1E90FF); height:100vh; display:flex; }
    .app { display:flex; width:100%; height:100vh; }
    
    /* Sidebar */
    .sidebar { width:30%; background:rgba(255,255,255,0.15); backdrop-filter:blur(10px); border-right:1px solid rgba(255,255,255,0.3); display:flex; flex-direction:column; }
    .sidebar h2 { text-align:center; color:white; padding:15px; margin:0; background:#1E90FF; }
    .chat-list { flex:1; overflow-y:auto; padding:10px; }
    .chat-item { padding:12px; margin-bottom:8px; background:rgba(255,255,255,0.3); border-radius:12px; cursor:pointer; color:#003366; font-weight:bold; transition:0.2s; }
    .chat-item:hover { background:rgba(255,255,255,0.5); }

    /* Chat area */
    .chat-area { flex:1; display:flex; flex-direction:column; }
    .chat-header { background:#1E90FF; color:white; padding:15px; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
    .messages { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; }
    .bubble { max-width:70%; padding:10px 14px; border-radius:20px; margin-bottom:8px; word-wrap:break-word; }
    .you { align-self:flex-end; background:#ADD8E6; }
    .friend { align-self:flex-start; background:#E0FFFF; }
    .input-area { display:flex; padding:10px; background:rgba(255,255,255,0.2); }
    .input-area input { flex:1; padding:12px; border-radius:25px; border:none; }
    .input-area button { margin-left:8px; padding:10px 16px; border:none; border-radius:25px; background:#00BFFF; color:white; font-weight:bold; cursor:pointer; }
    #typing { font-size:12px; color:white; padding-left:15px; }

    /* Auth box */
    .auth-box { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .auth-box input { margin:5px; padding:12px; width:250px; border-radius:25px; border:none; }
    .auth-box button { margin:5px; padding:10px 20px; border-radius:25px; border:none; background:#00BFFF; color:white; font-weight:bold; cursor:pointer; }

    /* Mobile */
    @media (max-width:768px){
      .sidebar { width:100%; position:absolute; z-index:2; height:100%; }
      .chat-area { width:100%; }
      .hide { display:none; }
    }
  </style>
</head>
<body>

<div class="auth-box" id="authBox">
  <h2 style="color:white;">Talksy Mini ðŸ’¬ Login</h2>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button onclick="signUp()">Sign Up</button>
  <button onclick="login()">Login</button>
  <hr style="width:200px;">
  <button onclick="googleLogin()">Sign In with Google</button>
</div>

<div class="app" id="app" style="display:none;">

  <div class="sidebar" id="sidebar">
    <h2>Talksy Mini ðŸ’¬</h2>
    <div style="padding:10px;">
      <input type="text" id="newGroupName" placeholder="New Group Name">
      <button onclick="createGroup()">Create</button>
    </div>
    <div class="chat-list" id="chatList"></div>
    <button onclick="logout()" style="margin:10px; background:#FF3B3B;">Logout</button>
  </div>

  <div class="chat-area">
    <div class="chat-header">
      <span id="chatTitle">Select Chat</span>
      <button onclick="showSidebar()">Chats</button>
    </div>
    <div id="typing"></div>
    <div class="messages" id="messages"></div>
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="Type message">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "talksy-mini.firebaseapp.com",
  projectId: "talksy-mini"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentChat = null;
let currentType = null;
let typingTimeout;

const chatList = document.getElementById("chatList");
const messagesDiv = document.getElementById("messages");
const chatTitle = document.getElementById("chatTitle");
const typingDiv = document.getElementById("typing");

const authBox = document.getElementById("authBox");
const appDiv = document.getElementById("app");

/* ---------- AUTH ---------- */
function signUp(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  auth.createUserWithEmailAndPassword(email,password).catch(e=>alert(e.message));
}
function login(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  auth.signInWithEmailAndPassword(email,password).catch(e=>alert(e.message));
}
function googleLogin(){
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithRedirect(provider); // <- redirect method
}
function logout(){
  auth.signOut();
  currentChat=null;
  currentType=null;
  authBox.style.display="flex";
  appDiv.style.display="none";
}

/* ---------- HANDLE REDIRECT RESULT ---------- */
auth.getRedirectResult()
  .then((result)=>{
    if(result.user){
      authBox.style.display="none";
      appDiv.style.display="flex";
      loadChats();
    }
  })
  .catch((error)=>{
    console.error(error.message);
    alert("Google sign-in failed: "+error.message);
  });

auth.onAuthStateChanged(user=>{
  if(user){
    authBox.style.display="none";
    appDiv.style.display="flex";
    loadChats();
  }
});

/* ---------- CHAT SYSTEM ---------- */
function loadChats(){
  chatList.innerHTML="";
  addChatItem("General Group","group","general");

  // Groups
  db.collection("groups").onSnapshot(snapshot=>{
    snapshot.forEach(doc=>{
      addChatItem(doc.data().name,"group",doc.id);
    });
  });

  // Private Users
  db.collection("private").onSnapshot(snapshot=>{
    snapshot.forEach(doc=>{
      addChatItem(doc.data().name,"private",doc.id);
    });
  });
}

function addChatItem(name,type,id){
  const div=document.createElement("div");
  div.className="chat-item";
  div.innerText=name;
  div.onclick=()=> openChat(name,type,id);
  chatList.appendChild(div);
}

function openChat(name,type,id){
  currentChat=id;
  currentType=type;
  chatTitle.innerText=name;
  messagesDiv.innerHTML="";
  document.getElementById("sidebar").classList.add("hide");
  loadMessages();
}

function loadMessages(){
  if(!currentChat) return;
  const col = currentType==="group"?"groups":"private";
  db.collection(col).doc(currentChat).collection("messages").orderBy("timestamp")
    .onSnapshot(snapshot=>{
      messagesDiv.innerHTML="";
      snapshot.forEach(doc=>{
        const msg=doc.data();
        const div=document.createElement("div");
        div.className="bubble "+(msg.uid===auth.currentUser.uid?"you":"friend");
        div.innerText=msg.text;
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop=messagesDiv.scrollHeight;
    });

  // Typing indicator
  db.collection(currentType==="group"?"groups":"private").doc(currentChat)
    .collection("typingStatus").doc("status")
    .onSnapshot(doc=>{
      const data=doc.data();
      if(data && data.isTyping && data.uid!==auth.currentUser.uid){
        typingDiv.innerText="Someone is typing...";
      } else typingDiv.innerText="";
    });
}

document.getElementById("messageInput").addEventListener("input",()=>{
  if(!currentChat) return;
  db.collection(currentType==="group"?"groups":"private").doc(currentChat)
    .collection("typingStatus").doc("status")
    .set({uid:auth.currentUser.uid,isTyping:true},{merge:true});

  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>{
    db.collection(currentType==="group"?"groups":"private").doc(currentChat)
      .collection("typingStatus").doc("status")
      .set({uid:auth.currentUser.uid,isTyping:false},{merge:true});
  },1500);
});

function sendMessage(){
  if(!currentChat) return alert("Select a chat");
  const text=document.getElementById("messageInput").value;
  if(!text) return;
  const col = currentType==="group"?"groups":"private";
  db.collection(col).doc(currentChat).collection("messages").add({
    uid:auth.currentUser.uid,
    text:text,
    timestamp:Date.now()
  });
  document.getElementById("messageInput").value="";
  db.collection(col).doc(currentChat)
    .collection("typingStatus").doc("status")
    .set({uid:auth.currentUser.uid,isTyping:false},{merge:true});
}

function createGroup(){
  const name=document.getElementById("newGroupName").value.trim();
  if(!name) return;
  db.collection("groups").add({name:name,createdAt:Date.now()});
  document.getElementById("newGroupName").value="";
}

function showSidebar(){ document.getElementById("sidebar").classList.remove("hide"); }
</script>

</body>
</html>
