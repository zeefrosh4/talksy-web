<!DOCTYPE html>
<html>
<head>
  <title>Talksy Mini WhatsApp Full UI</title>
  <style>
    body { margin:0; font-family: Arial; background:#e5ddd5; }
    h1 { text-align:center; background:#075E54; color:white; padding:15px; margin:0; }
    
    /* Auth */
    .auth-box { text-align:center; padding:20px; }
    input { padding:10px; border-radius:20px; border:none; margin:5px; width:250px; }
    button { padding:8px 14px; border-radius:20px; border:none; cursor:pointer; font-weight:bold; margin:3px; }

    /* Chat selection */
    .chat-selection { display:none; max-width:500px; margin:auto; padding:20px; }
    .chatItem { display:flex; align-items:center; padding:8px; background:#fff; border-radius:10px; margin:5px 0; cursor:pointer; box-shadow:0 1px 3px rgba(0,0,0,0.2); }
    .chatItem:hover { background:#f1f1f1; }
    .chatItem img { width:40px; height:40px; border-radius:50%; margin-right:10px; }
    .chatItem .name { font-weight:bold; flex:1; }
    .online-dot { width:10px; height:10px; background:#4CAF50; border-radius:50%; margin-left:5px; }
    
    /* Chat box */
    .chat-box { display:none; max-width:600px; margin:auto; }
    .chat-header { background:#075E54; color:white; padding:10px; display:flex; align-items:center; border-radius:0 0 15px 15px; }
    .chat-header img { width:40px; height:40px; border-radius:50%; margin-right:10px; }
    .chat-header .title { flex:1; font-weight:bold; }
    .messages { background:#ece5dd; height:400px; overflow-y:auto; padding:10px; }
    .bubble { padding:10px; border-radius:15px; margin:5px 0; max-width:70%; position:relative; display:inline-block; word-wrap:break-word; }
    .bubble.you { background:#dcf8c6; margin-left:auto; text-align:right; }
    .bubble.friend { background:#fff; margin-right:auto; text-align:left; }
    .timestamp { font-size:10px; color:gray; display:block; margin-top:5px; }
    .emojiBtn { background:none; border:none; font-size:16px; cursor:pointer; margin-left:4px; }
    .emojiBtn:hover { transform:scale(1.2); }
    .likeBtn { background:#34b7f1; color:white; border-radius:15px; padding:3px 8px; margin-left:4px; font-size:12px; }
    .deleteBtn { background:#ff4b5c; color:white; border-radius:15px; padding:3px 8px; margin-left:4px; font-size:12px; }

    /* Input box */
    .input-box { display:flex; margin-top:10px; }
    .input-box input { flex:1; padding:10px; border-radius:20px; border:none; }
    .input-box button { margin-left:5px; }
  </style>
</head>
<body>

<h1>Talksy Mini WhatsApp</h1>

<div class="auth-box" id="authBox">
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button onclick="signUp()">Sign Up</button>
  <button onclick="login()">Login</button>
</div>

<div class="chat-selection" id="chatSelection">
  <p id="welcome"></p>
  <button onclick="logout()">Logout</button><br><br>

  <input type="text" id="groupName" placeholder="New group name">
  <button onclick="createGroup()">Create Group</button><br><br>

  <input type="text" id="friendEmail" placeholder="Friend's email">
  <button onclick="startPrivateChat()">Start Private Chat</button>

  <h3>Groups</h3>
  <div id="groupList"></div>

  <h3>Private Chats</h3>
  <div id="privateList"></div>
</div>

<div class="chat-box" id="chatBox">
  <div class="chat-header">
    <img src="https://i.pravatar.cc/40" alt="avatar">
    <div class="title" id="chatTitle"></div>
  </div>
  <div class="messages" id="posts"></div>

  <div class="input-box">
    <input type="text" id="messageInput" placeholder="Type a message">
    <button onclick="sendMessage()">Send</button>
    <button onclick="backToSelection()">Back</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCK3dYhgPl-CWJ9JuiI2rVuuv00Q7Do9f4",
  authDomain: "talksy-mini.firebaseapp.com",
  projectId: "talksy-mini",
  storageBucket: "talksy-mini.appspot.com",
  messagingSenderId: "1044754891732",
  appId: "1:1044754891732:web:9b933f3d18a17e246a8c41"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const authBox=document.getElementById("authBox");
const chatSelection=document.getElementById("chatSelection");
const chatBox=document.getElementById("chatBox");
const postsDiv=document.getElementById("posts");
const welcome=document.getElementById("welcome");
const chatTitle=document.getElementById("chatTitle");
const groupList=document.getElementById("groupList");
const privateList=document.getElementById("privateList");

let currentChatId=null;
let currentChatType=null;

// AUTH
function signUp(){ const email=document.getElementById("email").value; const password=document.getElementById("password").value; auth.createUserWithEmailAndPassword(email,password).catch(e=>alert(e.message)); }
function login(){ const email=document.getElementById("email").value; const password=document.getElementById("password").value; auth.signInWithEmailAndPassword(email,password).catch(e=>alert(e.message)); }
function logout(){ auth.signOut(); currentChatId=null; currentChatType=null; }

auth.onAuthStateChanged(user=>{
  if(user){
    authBox.style.display="none";
    chatSelection.style.display="block";
    chatBox.style.display="none";
    welcome.innerText="Logged in as: "+user.email.split("@")[0];
    loadGroupList();
    loadPrivateList();
  } else { authBox.style.display="block"; chatSelection.style.display="none"; chatBox.style.display="none"; }
});

// PRIVATE CHAT
function startPrivateChat(){
  const user=auth.currentUser;
  const friendEmail=document.getElementById("friendEmail").value.trim().toLowerCase();
  if(!friendEmail) return alert("Enter friend's email!");
  const users=[user.email,friendEmail].sort();
  currentChatId=btoa(users.join("_"));
  currentChatType="private";
  openChat(currentChatId,currentChatType,"Private: "+friendEmail.split("@")[0]);
}

// GROUP
function createGroup(){
  const groupName=document.getElementById("groupName").value.trim();
  if(!groupName) return alert("Enter group name");
  db.collection("group_chats").add({name:groupName, members:[auth.currentUser.uid]});
  document.getElementById("groupName").value="";
}

// BACK
function backToSelection(){
  chatBox.style.display="none";
  chatSelection.style.display="block";
  currentChatId=null;
  currentChatType=null;
}

// OPEN CHAT
function openChat(chatId,type,title){
  chatBox.style.display="block";
  chatSelection.style.display="none";
  chatTitle.innerText=title;
  postsDiv.innerHTML="";
  if(type==="private") loadMessages("private",chatId);
  else loadMessages("group",chatId);
}

// SEND MESSAGE
function sendMessage(){
  const user=auth.currentUser;
  const message=document.getElementById("messageInput").value;
  if(!message) return;
  if(!currentChatId) return alert("Select a chat!");

  const collectionRef=currentChatType==="private"? db.collection("private_chats").doc(currentChatId).collection("messages") :
    db.collection("group_chats").doc(currentChatId).collection("messages");

  collectionRef.add({
    uid:user.uid,
    email:user.email,
    message:message,
    timestamp:Date.now(),
    likes:0,
    reactions:{"‚ù§Ô∏è":0,"üòÇ":0,"üòÆ":0}
  });
  document.getElementById("messageInput").value="";
}

// LOAD MESSAGES
function loadMessages(type,id){
  const user=auth.currentUser;
  const collectionRef=type==="private"? db.collection("private_chats").doc(id).collection("messages") :
    db.collection("group_chats").doc(id).collection("messages");

  collectionRef.orderBy("timestamp").onSnapshot(snapshot=>{
    postsDiv.innerHTML="";
    snapshot.forEach(doc=>{
      const post=doc.data();
      const bubble=document.createElement("div");
      bubble.className="bubble "+(post.uid===user.uid?"you":"friend");
      const time=new Date(post.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      bubble.innerHTML=`
        ${post.message}
        <span class="timestamp">${time}</span><br>
        <button class="likeBtn">Like ‚ù§Ô∏è ${post.likes}</button>
        <button class="emojiBtn">‚ù§Ô∏è ${post.reactions["‚ù§Ô∏è"]}</button>
        <button class="emojiBtn">üòÇ ${post.reactions["üòÇ"]}</button>
        <button class="emojiBtn">üòÆ ${post.reactions["üòÆ"]}</button>
      `;
      if(post.uid===user.uid){
        const del=document.createElement("button");
        del.innerText="Delete";
        del.className="deleteBtn";
        del.onclick=()=>collectionRef.doc(doc.id).delete();
        bubble.appendChild(del);
      }
      postsDiv.appendChild(bubble);
      postsDiv.scrollTop=postsDiv.scrollHeight;

      // Like
      bubble.querySelector(".likeBtn").addEventListener("click",()=>collectionRef.doc(doc.id).update({likes:post.likes+1}));
      // Emoji
      bubble.querySelectorAll(".emojiBtn").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const emoji=btn.textContent.trim().split(" ")[0];
          const updated={...post.reactions};
          updated[emoji]=post.reactions[emoji]+1;
          collectionRef.doc(doc.id).update({reactions:updated});
        });
      });
    });
  });
}

// LOAD GROUPS
function loadGroupList(){
  db.collection("group_chats").onSnapshot(snapshot=>{
    groupList.innerHTML="";
    snapshot.forEach(doc=>{
      const group=doc.data();
      const div=document.createElement("div");
      div.className="chatItem";
      div.innerHTML=`<img src="https://i.pravatar.cc/40?u=${doc.id}"><span class="name">${group.name}</span>`;
      div.onclick=()=>openChat(doc.id,"group",group.name);
      groupList.appendChild(div);
    });
  });
}

// LOAD PRIVATE
function loadPrivateList(){
  const user=auth.currentUser;
  db.collection("private_chats").onSnapshot(snapshot=>{
    privateList.innerHTML="";
    snapshot.forEach(doc=>{
      const usersInChat=atob(doc.id).split("_");
      const friendEmail=usersInChat.find(e=>e!==user.email);
      if(friendEmail){
        const div=document.createElement("div");
        div.className="chatItem";
        div.innerHTML=`<img src="https://i.pravatar.cc/40?u=${friendEmail}"><span class="name">${friendEmail.split("@")[0]}</span>`;
        div.onclick=()=>openChat(doc.id,"private","Private: "+friendEmail.split("@")[0]);
        privateList.appendChild(div);
      }
    });
  });
}

document.getElementById("messageInput").addEventListener("keypress",e=>{
  if(e.key==="Enter") sendMessage();
});
</script>
</body>
</html>
