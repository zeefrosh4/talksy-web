<!DOCTYPE html>
<html>
<head>
  <title>Talksy Mini Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family:'Segoe UI', Arial; background:linear-gradient(to right, #87CEFA, #1E90FF); }
    h1 { text-align:center; color:white; padding:15px; margin:0; font-size:22px; }

    .auth-box { text-align:center; padding:20px; }
    input { padding:12px; border-radius:25px; border:none; margin:5px; width:90%; max-width:300px; font-size:16px; }
    button { padding:10px 16px; border-radius:25px; border:none; cursor:pointer; font-weight:bold; margin:5px; background:#00BFFF; color:white; font-size:16px; }
    button:hover { opacity:0.9; }

    .chat-selection { display:none; max-width:500px; margin:auto; padding:20px; background:rgba(255,255,255,0.1); border-radius:15px; }

    .chatItem { display:flex; align-items:center; padding:12px; background:rgba(255,255,255,0.3); border-radius:15px; margin:8px 0; cursor:pointer; transition:0.2s; }
    .chatItem:hover { background:rgba(255,255,255,0.5); }
    .chatItem img { width:50px; height:50px; border-radius:50%; margin-right:12px; border:2px solid #00BFFF; }
    .chatItem .name { font-weight:bold; flex:1; font-size:16px; }

    .chat-box { max-width:600px; margin:auto; height:85vh; display:flex; flex-direction:column; background:rgba(255,255,255,0.2); border-radius:15px; }
    .chat-header { background:#1E90FF; color:white; padding:12px; display:flex; align-items:center; border-radius:15px 15px 0 0; flex-shrink:0; }
    .chat-header img { width:45px; height:45px; border-radius:50%; margin-right:12px; border:2px solid #FFF; }
    .chat-header .title { flex:1; font-weight:bold; font-size:16px; }

    .messages { background:rgba(255,255,255,0.1); flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; scroll-behavior:smooth; }
    .bubble { padding:10px 14px; border-radius:18px; margin:5px 0; max-width:75%; word-wrap:break-word; position:relative; display:inline-block; font-size:15px; }
    .bubble.you { background:#ADD8E6; align-self:flex-end; text-align:right; }
    .bubble.friend { background:#E0FFFF; align-self:flex-start; text-align:left; }
    .timestamp { font-size:10px; color:gray; display:block; margin-top:5px; }

    .emojiBtn { background:none; border:none; font-size:16px; cursor:pointer; margin-left:4px; }
    .emojiBtn:hover { transform:scale(1.2); }
    .likeBtn { background:#00BFFF; color:white; border-radius:15px; padding:4px 10px; margin-left:4px; font-size:12px; }
    .deleteBtn { background:#FF3B3B; color:white; border-radius:15px; padding:4px 10px; margin-left:4px; font-size:12px; }

    .input-box { display:flex; margin-top:10px; padding:10px; background:rgba(255,255,255,0.2); border-top:1px solid #87CEFA; flex-shrink:0; }
    .input-box input { flex:1; padding:12px; border-radius:25px; border:none; font-size:16px; }
    .input-box button { margin-left:5px; padding:12px 16px; font-size:16px; border-radius:25px; }

    @media screen and (max-width:480px){
      .chat-box { max-width:100%; height:90vh; }
      .bubble { font-size:14px; max-width:80%; }
      h1 { font-size:20px; }
    }
  </style>
</head>
<body>

<h1>Talksy Mini Chat</h1>

<div class="auth-box" id="authBox">
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button onclick="signUp()">Sign Up</button>
  <button onclick="login()">Login</button>
</div>

<div class="chat-selection" id="chatSelection">
  <p id="welcome"></p>
  <button onclick="logout()">Logout</button><br><br>

  <input type="text" id="friendEmail" placeholder="Friend's email">
  <button onclick="startPrivateChat()">Start Private Chat</button>

  <h3>Private Chats</h3>
  <div id="privateList"></div>
</div>

<div class="chat-box" id="chatBox" style="display:none;">
  <div class="chat-header">
    <img src="https://i.pravatar.cc/45" alt="avatar">
    <div class="title" id="chatTitle">General Group</div>
  </div>
  <div class="messages" id="posts"></div>

  <div class="input-box">
    <input type="text" id="messageInput" placeholder="Type a message">
    <button onclick="sendMessage()">Send</button>
    <button onclick="goGeneralGroup()">Back</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCK3dYhgPl-CWJ9JuiI2rVuuv00Q7Do9f4",
  authDomain: "talksy-mini.firebaseapp.com",
  projectId: "talksy-mini",
  storageBucket: "talksy-mini.appspot.com",
  messagingSenderId: "1044754891732",
  appId: "1:1044754891732:web:9b933f3d18a17e246a8c41"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const authBox = document.getElementById("authBox");
const chatSelection = document.getElementById("chatSelection");
const chatBox = document.getElementById("chatBox");
const postsDiv = document.getElementById("posts");
const chatTitle = document.getElementById("chatTitle");
const messageInput = document.getElementById("messageInput");
const welcome = document.getElementById("welcome");
const privateList = document.getElementById("privateList");

let currentChatId = "general_group";
let currentChatType = "group";

// AUTH
function signUp(){ const email=document.getElementById("email").value; const password=document.getElementById("password").value; auth.createUserWithEmailAndPassword(email,password).catch(e=>alert(e.message)); }
function login(){ const email=document.getElementById("email").value; const password=document.getElementById("password").value; auth.signInWithEmailAndPassword(email,password).catch(e=>alert(e.message)); }
function logout(){ auth.signOut(); currentChatId="general_group"; currentChatType="group"; }

// AUTH STATE
auth.onAuthStateChanged(user=>{
  if(user){
    authBox.style.display="none";
    chatSelection.style.display="block";
    chatBox.style.display="flex";
    welcome.innerText = "Logged in as: "+user.email.split("@")[0];

    // Ensure General group exists
    db.collection("group_chats").doc("general_group").set({name:"General", members:[]}, {merge:true});

    loadMessages("group","general_group");
    loadPrivateList();
    history.pushState(null,null,location.href);
  } else {
    authBox.style.display="block";
    chatSelection.style.display="none";
    chatBox.style.display="none";
  }
});

// SEND MESSAGE
function sendMessage(){
  const user=auth.currentUser;
  const message = messageInput.value.trim();
  if(!message) return;

  let collectionRef;
  if(currentChatType==="group") collectionRef = db.collection("group_chats").doc(currentChatId).collection("messages");
  else collectionRef = db.collection("private_chats").doc(currentChatId).collection("messages");

  collectionRef.add({
    uid:user.uid,
    email:user.email,
    message:message,
    timestamp:Date.now(),
    likes:0,
    reactions:{"‚ù§Ô∏è":0,"üòÇ":0,"üòÆ":0}
  });

  messageInput.value="";
}

// LOAD MESSAGES
function loadMessages(type,id){
  const user = auth.currentUser;
  const collectionRef = (type==="group"? db.collection("group_chats").doc(id).collection("messages") :
                                          db.collection("private_chats").doc(id).collection("messages")).orderBy("timestamp");

  collectionRef.onSnapshot(snapshot=>{
    postsDiv.innerHTML="";
    snapshot.forEach(doc=>{
      const post = doc.data();
      const bubble = document.createElement("div");
      bubble.className = "bubble "+(post.uid===user.uid?"you":"friend");
      const time = new Date(post.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      bubble.innerHTML=`
        ${post.message}
        <span class="timestamp">${time}</span><br>
        <button class="likeBtn">Like ‚ù§Ô∏è ${post.likes}</button>
        <button class="emojiBtn">‚ù§Ô∏è ${post.reactions["‚ù§Ô∏è"]}</button>
        <button class="emojiBtn">üòÇ ${post.reactions["üòÇ"]}</button>
        <button class="emojiBtn">üòÆ ${post.reactions["üòÆ"]}</button>
      `;
      if(post.uid===user.uid){
        const del = document.createElement("button");
        del.innerText = "Delete";
        del.className = "deleteBtn";
        del.onclick = ()=> {
          const collection = type==="group"? db.collection("group_chats").doc(id).collection("messages") :
                                              db.collection("private_chats").doc(id).collection("messages");
          collection.doc(doc.id).delete();
        };
        bubble.appendChild(del);
      }
      postsDiv.appendChild(bubble);
      postsDiv.scrollTop = postsDiv.scrollHeight;

      // Like & Emoji
      bubble.querySelector(".likeBtn").addEventListener("click",()=> {
        const collection = type==="group"? db.collection("group_chats").doc(id).collection("messages") :
                                            db.collection("private_chats").doc(id).collection("messages");
        collection.doc(doc.id).update({likes:post.likes+1});
      });
      bubble.querySelectorAll(".emojiBtn").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const emoji = btn.textContent.trim().split(" ")[0];
          const updated = {...post.reactions};
          updated[emoji] = post.reactions[emoji]+1;
          const collection = type==="group"? db.collection("group_chats").doc(id).collection("messages") :
                                              db.collection("private_chats").doc(id).collection("messages");
          collection.doc(doc.id).update({reactions:updated});
        });
      });
    });
  });
}

// PRIVATE CHAT
function startPrivateChat(){
  const user=auth.currentUser;
  const friendEmail = document.getElementById("friendEmail").value.trim().toLowerCase();
  if(!friendEmail) return alert("Enter friend's email!");
  const users = [user.email, friendEmail].sort();
  const chatId = btoa(users.join("_"));

  db.collection("private_chats").doc(chatId).set({users},{merge:true}).then(()=>{
    openPrivateChat(chatId, friendEmail);
  });

  document.getElementById("friendEmail").value="";
}

function openPrivateChat(chatId, friendEmail){
  currentChatId = chatId;
  currentChatType = "private";
  chatTitle.innerText = "Private: " + friendEmail.split("@")[0];
  postsDiv.innerHTML="";
  chatSelection.style.display = "none";
  chatBox.style.display = "flex";
  loadMessages("private", chatId);
  history.pushState(null,null,location.href);
}

// LOAD PRIVATE LIST
function loadPrivateList(){
  const user = auth.currentUser;
  db.collection("private_chats").onSnapshot(snapshot=>{
    privateList.innerHTML="";
    snapshot.forEach(doc=>{
      const usersInChat = atob(doc.id).split("_");
      const friendEmail = usersInChat.find(e=>e!==user.email);
      if(friendEmail){
        const div = document.createElement("div");
        div.className = "chatItem";
        div.innerHTML=`<img src="https://i.pravatar.cc/50?u=${friendEmail}"><span class="name">${friendEmail.split("@")[0]}</span>`;
        div.onclick=()=> openPrivateChat(doc.id, friendEmail);
        privateList.appendChild(div);
      }
    });
  });
}

// GO BACK TO GENERAL GROUP
function goGeneralGroup(){
  currentChatId = "general_group";
  currentChatType = "group";
  chatTitle.innerText = "General Group";
  postsDiv.innerHTML="";
  loadMessages("group","general_group");
}

// HANDLE BACK BUTTON
window.onpopstate = function(){
  if(currentChatType==="private"){
    goGeneralGroup();
    history.pushState(null,null,location.href);
  }
};

messageInput.addEventListener("keypress", e=>{
  if(e.key==="Enter") sendMessage();
});
</script>

</body>
</html>
