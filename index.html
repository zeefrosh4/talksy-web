<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Talksy Web</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, push, onValue, set, get, child } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

// ----------------- FIREBASE CONFIG -----------------
const firebaseConfig = {
  apiKey: "AIzaSyCK3dYhgPl-CWJ9JuiI2rVuuv00Q7Do9f4",
  authDomain: "talksy-mini.firebaseapp.com",
  databaseURL: "https://talksy-mini-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "talksy-mini",
  storageBucket: "talksy-mini.firebasestorage.app",
  messagingSenderId: "1044754891732",
  appId: "1:1044754891732:web:9b933f3d18a17e246a8c41"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// ----------------- LOGIN SCREEN -----------------
const loginDiv = document.createElement("div");
loginDiv.innerHTML = `
  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#f0f4f8;">
    <h1 style="color:#3b82f6;">Talksy Web</h1>
    <input id="email" placeholder="Email" style="padding:10px;margin:5px;border-radius:5px;border:1px solid #ccc;width:200px;">
    <input id="password" type="password" placeholder="Password" style="padding:10px;margin:5px;border-radius:5px;border:1px solid #ccc;width:200px;">
    <button id="loginBtn" style="padding:10px 20px;margin:5px;background:#3b82f6;color:white;border:none;border-radius:5px;cursor:pointer;">Login</button>
    <button id="signupBtn" style="padding:10px 20px;margin:5px;background:#00a8ff;color:white;border:none;border-radius:5px;cursor:pointer;">Sign Up</button>
  </div>
`;
document.body.appendChild(loginDiv);

// ----------------- APP UI -----------------
const appDiv = document.createElement("div");
appDiv.style.display="none";
appDiv.innerHTML = `
<div style="display:flex;height:100vh;font-family:Arial,sans-serif;background:#f4f7fb;color:#1e293b;">
  <!-- Sidebar -->
  <div style="width:30%;background:white;border-right:1px solid #e2e8f0;display:flex;flex-direction:column;">
    <div style="padding:18px;font-size:20px;font-weight:bold;color:#3b82f6;">Talksy</div>
    <input id="searchUser" placeholder="Search users..." style="padding:10px;margin:10px;border-radius:20px;border:1px solid #e2e8f0;">
    <div id="userList" style="flex:1;overflow-y:auto;"></div>
  </div>
  
  <!-- Chat area -->
  <div style="width:70%;display:flex;flex-direction:column;">
    <div style="padding:15px;background:white;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;">
      <div id="chatHeader" style="font-weight:bold;display:flex;align-items:center;"><img id="headerAvatar" src="" style="width:40px;height:40px;border-radius:50%;margin-right:10px;"> <span id="chatTitle">Select a chat</span></div>
      <div><span id="callBtn" style="margin-left:15px;cursor:pointer;color:#3b82f6;">ðŸ“ž</span><span id="videoBtn" style="margin-left:15px;cursor:pointer;color:#3b82f6;">ðŸ“¹</span><span id="logoutBtn" style="margin-left:15px;cursor:pointer;color:#f87171;">ðŸšª</span></div>
    </div>
    <div id="messages" style="flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;background:#f4f7fb;"></div>
    <div style="padding:15px;background:white;border-top:1px solid #e2e8f0;display:flex;">
      <input id="messageInput" placeholder="Type a message..." style="flex:1;padding:10px;border-radius:20px;border:1px solid #e2e8f0;">
      <button id="sendBtn" style="margin-left:10px;padding:10px 15px;border:none;border-radius:50%;background:#3b82f6;color:white;font-size:16px;cursor:pointer;">âž¤</button>
    </div>
  </div>
</div>
`;
document.body.appendChild(appDiv);

// ----------------- AUTH -----------------
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
document.getElementById("loginBtn").onclick = ()=>signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value).catch(e=>alert(e.message));
document.getElementById("signupBtn").onclick = ()=>createUserWithEmailAndPassword(auth,emailInput.value,passwordInput.value).catch(e=>alert(e.message));

let currentUser=null;
let currentChatId=null;

onAuthStateChanged(auth,(user)=>{
  if(user){
    currentUser=user;
    loginDiv.style.display="none";
    appDiv.style.display="block";
    registerUser();
    loadUsers();
  } else {
    loginDiv.style.display="block";
    appDiv.style.display="none";
  }
});

document.getElementById("logoutBtn").onclick=()=>signOut(auth);

// ----------------- REGISTER USER IN DB -----------------
function registerUser(){
  set(ref(db,"users/"+currentUser.uid),{
    name: currentUser.email.split("@")[0],
    email: currentUser.email,
    photo:"https://i.pravatar.cc/150?img=5"
  });
}

// ----------------- ADD DUMMY USERS IF NONE -----------------
function addDummyUsersIfEmpty(){
  const usersRef = ref(db,"users");
  get(usersRef).then(snapshot=>{
    if(!snapshot.exists()){
      set(ref(db,"users/user1"),{
        name:"Emma Wilson",
        email:"emma@example.com",
        photo:"https://i.pravatar.cc/150?img=5"
      });
      set(ref(db,"users/user2"),{
        name:"Michael Chen",
        email:"michael@example.com",
        photo:"https://i.pravatar.cc/150?img=12"
      });
    }
  });
}
addDummyUsersIfEmpty();

// ----------------- LOAD USERS -----------------
const userListDiv=document.getElementById("userList");
const messagesDiv=document.getElementById("messages");
const chatTitle=document.getElementById("chatTitle");
const headerAvatar=document.getElementById("headerAvatar");
const messageInput=document.getElementById("messageInput");
const sendBtn=document.getElementById("sendBtn");
const searchInput=document.getElementById("searchUser");

function loadUsers(){
  const dbRef = ref(db,"users");
  onValue(dbRef,(snapshot)=>{
    const users = snapshot.val() || {};
    userListDiv.innerHTML="";
    Object.keys(users).forEach(uid=>{
      if(uid===currentUser.uid) return; // skip self
      const u = users[uid];
      const div=document.createElement("div");
      div.innerHTML=`
      <div style="display:flex;align-items:center;padding:10px;cursor:pointer;" onclick="startChat('${uid}','${u.name}','${u.photo||'https://i.pravatar.cc/150?img=5'}',this)">
        <img src="${u.photo||'https://i.pravatar.cc/150?img=5'}" style="width:40px;height:40px;border-radius:50%;margin-right:10px;">
        <span>${u.name}</span>
      </div>`;
      userListDiv.appendChild(div);
    });
  });
}

// ----------------- START CHAT -----------------
window.startChat=(uid,name,photo,element)=>{
  document.querySelectorAll("#userList div").forEach(el=>el.style.background="");
  element.style.background="#e0ecff";
  chatTitle.innerText=name;
  headerAvatar.src=photo;
  currentChatId=[currentUser.uid,uid].sort().join("_");

  const chatRef = ref(db,"chats/"+currentChatId);
  onValue(chatRef,(snapshot)=>{
    messagesDiv.innerHTML="";
    const msgs = snapshot.val() || {};
    Object.keys(msgs).forEach(key=>{
      const m = msgs[key];
      const div=document.createElement("div");
      div.style.margin="5px";
      div.style.maxWidth="60%";
      div.style.padding="10px";
      div.style.borderRadius="12px";
      div.style.position="relative";
      div.style.fontSize="14px";
      div.style.marginBottom="8px";
      div.style.wordBreak="break-word";
      if(m.sender===currentUser.uid){
        div.style.alignSelf="flex-end";
        div.style.background="linear-gradient(135deg,#4da6ff,#3b82f6)";
        div.style.color="white";
      } else {
        div.style.alignSelf="flex-start";
        div.style.background="white";
        div.style.color="black";
      }
      div.innerHTML = m.text + `<div style="font-size:10px;margin-top:3px;opacity:0.7;text-align:right;">${m.time}</div>`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop=messagesDiv.scrollHeight;
    });
  });
};

// ----------------- SEND MESSAGE -----------------
sendBtn.onclick=()=>{
  if(!messageInput.value || !currentChatId) return;
  const chatRef=ref(db,"chats/"+currentChatId);
  push(chatRef,{
    sender: currentUser.uid,
    text: messageInput.value,
    time:new Date().getHours()+":"+String(new Date().getMinutes()).padStart(2,"0")
  });
  messageInput.value="";
};
</script>
</html>
