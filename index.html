<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Talksy Web - WhatsApp Style</title>
<style>
body, html { margin:0; padding:0; font-family: Arial; height:100%; background:#e0f7ff; }
#app { display:flex; height:100vh; }

/* Sidebar */
#sidebar {
  width: 300px; background:#f0f8ff; border-right:1px solid #ccc; display:flex; flex-direction:column;
}
#sidebar h2 { padding:10px; margin:0; background:#00bfff; color:white; text-align:center; }
#chatList { flex:1; overflow-y:auto; }
.chatItem { padding:10px; cursor:pointer; border-bottom:1px solid #ccc; }
.chatItem:hover { background:#add8e6; }

/* Main chat area */
#main { flex:1; display:flex; flex-direction:column; }
#chatHeader { padding:10px; background:#00bfff; color:white; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
#messages { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; }
.msg { max-width:70%; padding:5px 10px; margin:5px; border-radius:10px; word-wrap:break-word; }
.me { align-self:flex-end; background:#add8e6; }
.other { align-self:flex-start; background:#87ceeb; }

/* Input area */
#inputArea { display:flex; padding:10px; border-top:1px solid #ccc; }
#messageInput { flex:1; padding:10px; border-radius:20px; border:1px solid #ccc; }
#sendBtn { padding:10px 20px; border:none; border-radius:20px; background:#00bfff; color:white; margin-left:5px; cursor:pointer; }
#sendBtn:hover { background:#1e90ff; }
#typing { font-style:italic; padding:0 10px; color:#333; }

/* Back button */
#backBtn { display:none; padding:5px 10px; background:#1e90ff; color:white; border:none; border-radius:5px; cursor:pointer; margin-right:10px; }
#backBtn:hover { background:#00bfff; }
</style>
</head>
<body>

<div id="app">
  <!-- Sidebar -->
  <div id="sidebar">
    <h2>Talksy Web</h2>
    <div id="chatList"></div>
    <input type="text" id="newChatInput" placeholder="New chat email or group...">
    <button id="newChatBtn">Add Chat</button>
    <button id="logoutBtn">Logout</button>
  </div>

  <!-- Main chat -->
  <div id="main">
    <div id="chatHeader">
      <button id="backBtn">‚Üê Back</button>
      <span id="chatTitle">Select a chat</span>
    </div>
    <div id="messages"></div>
    <div id="typing"></div>
    <div id="inputArea">
      <input type="text" id="messageInput" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- Login UI -->
<div id="login" style="position:absolute; top:0; left:0; right:0; bottom:0; background:#e0f7ff; display:flex; justify-content:center; align-items:center;">
  <div style="background:#f0f8ff; padding:20px; border-radius:10px; text-align:center; width:300px;">
    <h2>Login / Sign Up</h2>
    <input type="email" id="email" placeholder="Email" style="width:100%; padding:10px; margin:5px 0;">
    <input type="password" id="password" placeholder="Password" style="width:100%; padding:10px; margin:5px 0;">
    <button id="loginBtn" style="width:100%; margin:5px 0;">Login</button>
    <button id="signupBtn" style="width:100%; margin:5px 0;">Sign Up</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyChDnxFngUE5PNQny6J1l-1Pu74gWn7LTY",
  authDomain: "talksy-live.firebaseapp.com",
  projectId: "talksy-live",
  storageBucket: "talksy-live.firebasestorage.app",
  messagingSenderId: "468137831789",
  appId: "1:468137831789:web:9872c8fb7a44f25a4cfe64"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
let currentChatId = null;

// Login & SignUp
document.getElementById('loginBtn').addEventListener('click', async () => {
  try {
    const userCred = await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
    currentUser = userCred.user;
    document.getElementById('login').style.display = 'none';
    loadChatList();
  } catch(e){ alert(e.message); }
});

document.getElementById('signupBtn').addEventListener('click', async () => {
  try {
    const userCred = await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
    currentUser = userCred.user;
    document.getElementById('login').style.display = 'none';
    loadChatList();
  } catch(e){ alert(e.message); }
});

document.getElementById('logoutBtn').addEventListener('click', async () => {
  await signOut(auth);
  currentUser = null;
  currentChatId = null;
  document.getElementById('login').style.display = 'flex';
});

// Back button
document.getElementById('backBtn').addEventListener('click', ()=>{
  currentChatId = null;
  document.getElementById('chatTitle').textContent = "Select a chat";
  document.getElementById('messages').innerHTML = '';
  document.getElementById('backBtn').style.display = 'none';
});

// Add new chat
document.getElementById('newChatBtn').addEventListener('click', async () => {
  const chatName = document.getElementById('newChatInput').value.trim();
  if(!chatName) return;
  const chatId = chatName.includes('@') ? [currentUser.email, chatName].sort().join('_') : chatName;
  await setDoc(doc(db, 'chats', chatId), { name: chatName });
  document.getElementById('newChatInput').value = '';
  loadChatList();
});

// Load chats in sidebar
async function loadChatList() {
  const chatListDiv = document.getElementById('chatList');
  chatListDiv.innerHTML = '';
  const querySnapshot = await getDocs(collection(db, 'chats'));
  querySnapshot.forEach(docSnap => {
    const div = document.createElement('div');
    div.classList.add('chatItem');
    div.textContent = docSnap.data().name;
    div.addEventListener('click', ()=>openChat(docSnap.id, docSnap.data().name));
    chatListDiv.appendChild(div);
  });
}

// Open chat
function openChat(chatId, chatName) {
  currentChatId = chatId;
  document.getElementById('chatTitle').textContent = chatName;
  document.getElementById('backBtn').style.display = 'inline-block';
  loadMessages(chatId);
}

// Send message
document.getElementById('sendBtn').addEventListener('click', async () => {
  const msgInput = document.getElementById('messageInput');
  const msg = msgInput.value.trim();
  if(!msg || !currentChatId) return;
  await addDoc(collection(db, 'chats', currentChatId, 'messages'), {
    text: msg,
    createdAt: serverTimestamp(),
    user: currentUser.email
  });
  msgInput.value = '';
});

// Load messages in real-time
function loadMessages(chatId) {
  const messagesDiv = document.getElementById('messages');
  messagesDiv.innerHTML = '';
  const q = query(collection(db, 'chats', chatId, 'messages'), orderBy('createdAt'));
  onSnapshot(q, snapshot => {
    messagesDiv.innerHTML = '';
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const div = document.createElement('div');
      div.textContent = `${data.user}: ${data.text}`;
      div.classList.add('msg');
      div.classList.add(currentUser.email === data.user ? 'me' : 'other');
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  });
}
</script>
</body>
</html>
