<!DOCTYPE html>
<html>
<head>
  <title>Talksy Private Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #ffecd2, #fcb69f);
      margin:0; padding:20px;
    }

    h1 { text-align:center; }

    input, select {
      padding:10px; margin:5px 0; border-radius:8px; border:none; width:250px;
    }

    button {
      padding:8px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; margin:3px;
    }

    .auth-box, .chat-box { text-align:center; }
    .chat-box { display:none; }

    .post {
      padding:12px;
      margin:10px 0;
      border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
      background:white;
      word-wrap:break-word;
      position:relative;
    }

    .deleteBtn { background:#ff4b5c; color:white; margin-left:5px; }
    .logoutBtn { background:#333; color:white; }
    .likeBtn { background:#4D96FF; color:white; margin-left:5px; }
    .emojiBtn { background:none; border:none; font-size:18px; cursor:pointer; margin-left:4px; }
    .emojiBtn:hover { transform:scale(1.2); }
    .likeCount, .reactionCount { font-weight:bold; margin-left:2px; }
  </style>
</head>
<body>

<h1>Talksy Private Chat</h1>

<div class="auth-box" id="authBox">
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button onclick="signUp()">Sign Up</button>
  <button onclick="login()">Login</button>
</div>

<div class="chat-box" id="chatBox">
  <p id="welcome"></p>
  <button class="logoutBtn" onclick="logout()">Logout</button><br><br>

  <input type="text" id="friendEmail" placeholder="Friend's email"><br>
  <button onclick="startChat()">Start Chat</button><br><br>

  <input type="text" id="messageInput" placeholder="Type message">
  <button onclick="sendMessage()">Send</button>

  <div id="posts"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCK3dYhgPl-CWJ9JuiI2rVuuv00Q7Do9f4",
  authDomain: "talksy-mini.firebaseapp.com",
  projectId: "talksy-mini",
  storageBucket: "talksy-mini.appspot.com",
  messagingSenderId: "1044754891732",
  appId: "1:1044754891732:web:9b933f3d18a17e246a8c41"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const authBox = document.getElementById("authBox");
const chatBox = document.getElementById("chatBox");
const postsDiv = document.getElementById("posts");
const welcome = document.getElementById("welcome");

let chatId = null; // current private chat ID

// SIGN UP
function signUp() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  auth.createUserWithEmailAndPassword(email, password).catch(e => alert(e.message));
}

// LOGIN
function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  auth.signInWithEmailAndPassword(email, password).catch(e => alert(e.message));
}

// LOGOUT
function logout() { auth.signOut(); chatId=null; }

// AUTH STATE
auth.onAuthStateChanged(user => {
  if(user){
    authBox.style.display="none";
    chatBox.style.display="block";
    welcome.innerText = "Logged in as: " + user.email.split("@")[0];
    postsDiv.innerHTML = "";
  } else {
    authBox.style.display="block";
    chatBox.style.display="none";
    postsDiv.innerHTML = "";
  }
});

// START CHAT
function startChat() {
  const user = auth.currentUser;
  const friendEmail = document.getElementById("friendEmail").value.trim().toLowerCase();
  if(!friendEmail) return alert("Enter your friend's email!");

  // Create unique chatId using both UIDs (alphabetical)
  const users = [user.email, friendEmail].sort();
  chatId = btoa(users.join("_")); // base64 encode for safe ID

  loadMessages();
}

// SEND MESSAGE
function sendMessage() {
  const user = auth.currentUser;
  const message = document.getElementById("messageInput").value;
  if(!message) return;
  if(!chatId) return alert("Start chat with a friend first!");

  db.collection("private_chats")
    .doc(chatId)
    .collection("messages")
    .add({
      uid: user.uid,
      email: user.email,
      message: message,
      timestamp: Date.now(),
      likes: 0,
      reactions: { "‚ù§Ô∏è":0, "üòÇ":0, "üòÆ":0 }
    });

  document.getElementById("messageInput").value="";
}

// LOAD MESSAGES
function loadMessages() {
  if(!chatId) return;

  db.collection("private_chats")
    .doc(chatId)
    .collection("messages")
    .orderBy("timestamp")
    .onSnapshot(snapshot=>{
      postsDiv.innerHTML="";
      snapshot.forEach(doc=>{
        const post = doc.data();
        const postDiv = document.createElement("div");
        postDiv.className="post";

        const displayName = post.email.split("@")[0];
        postDiv.innerHTML = `
          <strong>${displayName}</strong><br>
          ${post.message}<br>
          <button class="likeBtn">Like ‚ù§Ô∏è</button>
          <span class="likeCount">${post.likes}</span>
          <span>Reactions:</span>
          <button class="emojiBtn">‚ù§Ô∏è ${post.reactions["‚ù§Ô∏è"]}</button>
          <button class="emojiBtn">üòÇ ${post.reactions["üòÇ"]}</button>
          <button class="emojiBtn">üòÆ ${post.reactions["üòÆ"]}</button>
        `;

        // Delete only for owner
        if(post.uid===auth.currentUser.uid){
          const deleteBtn = document.createElement("button");
          deleteBtn.innerText="Delete";
          deleteBtn.className="deleteBtn";
          deleteBtn.onclick=()=>db.collection("private_chats").doc(chatId)
                                    .collection("messages").doc(doc.id).delete();
          postDiv.appendChild(deleteBtn);
        }

        postsDiv.appendChild(postDiv);

        // Like button
        const likeBtn = postDiv.querySelector(".likeBtn");
        likeBtn.addEventListener("click", ()=>{
          db.collection("private_chats").doc(chatId)
            .collection("messages").doc(doc.id)
            .update({ likes: post.likes+1 });
        });

        // Emoji buttons
        const emojiBtns = postDiv.querySelectorAll(".emojiBtn");
        emojiBtns.forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const emoji = btn.textContent.trim().split(" ")[0];
            const updated = {...post.reactions};
            updated[emoji] = post.reactions[emoji]+1;
            db.collection("private_chats").doc(chatId)
              .collection("messages").doc(doc.id)
              .update({ reactions: updated });
          });
        });
      });
    });
}

document.getElementById("messageInput").addEventListener("keypress", e=>{
  if(e.key==="Enter") sendMessage();
});
</script>
</body>
</html>
