<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Talksy Web</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { 
  getDatabase, ref, push, onValue, set, get, onDisconnect, update 
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
import { 
  getAuth, signInWithEmailAndPassword, 
  createUserWithEmailAndPassword, 
  onAuthStateChanged, signOut 
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK3dYhgPl-CWJ9JuiI2rVuuv00Q7Do9f4",
  authDomain: "talksy-mini.firebaseapp.com",
  databaseURL: "https://talksy-mini-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "talksy-mini",
  storageBucket: "talksy-mini.firebasestorage.app",
  messagingSenderId: "1044754891732",
  appId: "1:1044754891732:web:9b933f3d18a17e246a8c41"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let currentUser = null;
let currentChatId = null;
let unreadCounts = {};

// ---------------- LOGIN UI ----------------
document.body.innerHTML = `
<div id="login" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#f4f7fb;">
<h1 style="color:#3b82f6;">Talksy</h1>
<input id="email" placeholder="Email" style="padding:10px;margin:5px;">
<input id="password" type="password" placeholder="Password" style="padding:10px;margin:5px;">
<button id="loginBtn">Login</button>
<button id="signupBtn">Sign Up</button>
</div>

<div id="app" style="display:none;height:100vh;font-family:Arial;">
<div style="display:flex;height:100%;">
  
  <div style="width:30%;background:white;border-right:1px solid #ddd;display:flex;flex-direction:column;">
    <div style="padding:15px;font-weight:bold;color:#3b82f6;">Talksy</div>
    <div id="userList" style="flex:1;overflow-y:auto;"></div>
  </div>

  <div style="width:70%;display:flex;flex-direction:column;">
    <div style="padding:15px;background:white;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;">
      <div id="chatTitle">Select chat</div>
      <div>
        <span id="logout" style="cursor:pointer;color:red;">Logout</span>
      </div>
    </div>
    <div id="messages" style="flex:1;padding:20px;overflow-y:auto;background:#f4f7fb;display:flex;flex-direction:column;"></div>
    <div style="padding:15px;background:white;display:flex;">
      <input id="messageInput" style="flex:1;padding:10px;">
      <button id="sendBtn">Send</button>
    </div>
  </div>

</div>
</div>
`;

// ---------------- AUTH ----------------
document.getElementById("loginBtn").onclick = ()=>{
  signInWithEmailAndPassword(auth,
    email.value,password.value
  ).catch(e=>alert(e.message));
};

document.getElementById("signupBtn").onclick = ()=>{
  createUserWithEmailAndPassword(auth,
    email.value,password.value
  ).catch(e=>alert(e.message));
};

document.getElementById("logout").onclick = ()=>signOut(auth);

onAuthStateChanged(auth,(user)=>{
  if(user){
    currentUser = user;
    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="block";
    setupPresence();
    loadUsers();
  } else {
    document.getElementById("login").style.display="flex";
    document.getElementById("app").style.display="none";
  }
});

// ---------------- ONLINE STATUS ----------------
function setupPresence(){
  const userRef = ref(db,"users/"+currentUser.uid);

  const userData = {
    name: currentUser.email.split("@")[0],
    email: currentUser.email,
    photo:"https://i.pravatar.cc/150?img=5",
    status:"online",
    lastSeen: Date.now()
  };

  set(userRef,userData);

  onDisconnect(userRef).update({
    status:"offline",
    lastSeen: Date.now()
  });
}

// ---------------- LOAD USERS ----------------
function loadUsers(){
  onValue(ref(db,"users"), snapshot=>{
    const users = snapshot.val() || {};
    const userList = document.getElementById("userList");
    userList.innerHTML="";

    Object.keys(users).forEach(uid=>{
      if(uid===currentUser.uid) return;

      const u = users[uid];
      const chatId = [currentUser.uid,uid].sort().join("_");
      const unread = unreadCounts[chatId] || 0;

      const div = document.createElement("div");
      div.style.padding="10px";
      div.style.cursor="pointer";
      div.style.display="flex";
      div.style.justifyContent="space-between";
      div.onclick=()=>startChat(uid,u.name);

      div.innerHTML=`
      <div style="display:flex;align-items:center;">
        <div style="position:relative;margin-right:10px;">
          <img src="${u.photo}" style="width:40px;height:40px;border-radius:50%;">
          <span style="
            position:absolute;bottom:0;right:0;
            width:10px;height:10px;border-radius:50%;
            background:${u.status==="online"?"#22c55e":"#9ca3af"};
            border:2px solid white;"></span>
        </div>
        <span>${u.name}</span>
      </div>
      ${unread>0?`<span style="background:#3b82f6;color:white;border-radius:50%;padding:4px 8px;font-size:12px;">${unread}</span>`:""}
      `;

      userList.appendChild(div);

      monitorUnread(chatId,uid);
    });
  });
}

// ---------------- START CHAT ----------------
function startChat(uid,name){
  currentChatId=[currentUser.uid,uid].sort().join("_");
  document.getElementById("chatTitle").innerText=name;
  unreadCounts[currentChatId]=0;
  loadMessages();
}

// ---------------- LOAD MESSAGES ----------------
function loadMessages(){
  const messagesDiv=document.getElementById("messages");
  onValue(ref(db,"chats/"+currentChatId), snapshot=>{
    messagesDiv.innerHTML="";
    const msgs=snapshot.val()||{};
    Object.values(msgs).forEach(m=>{
      const div=document.createElement("div");
      div.style.maxWidth="60%";
      div.style.margin="5px";
      div.style.padding="10px";
      div.style.borderRadius="10px";
      div.style.alignSelf=m.sender===currentUser.uid?"flex-end":"flex-start";
      div.style.background=m.sender===currentUser.uid?
        "linear-gradient(135deg,#4da6ff,#3b82f6)":"white";
      div.style.color=m.sender===currentUser.uid?"white":"black";
      div.innerHTML=m.text+`<div style="font-size:10px;opacity:0.7;text-align:right;">${m.time}</div>`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop=messagesDiv.scrollHeight;
    });
  });
}

// ---------------- SEND ----------------
document.getElementById("sendBtn").onclick=()=>{
  if(!currentChatId || !messageInput.value) return;
  push(ref(db,"chats/"+currentChatId),{
    sender:currentUser.uid,
    text:messageInput.value,
    time:new Date().getHours()+":"+String(new Date().getMinutes()).padStart(2,"0")
  });
  messageInput.value="";
};

// ---------------- UNREAD BADGE ----------------
function monitorUnread(chatId,otherUid){
  onValue(ref(db,"chats/"+chatId), snapshot=>{
    const msgs=snapshot.val();
    if(!msgs) return;

    const lastMsg=Object.values(msgs).pop();
    if(lastMsg && lastMsg.sender!==currentUser.uid && chatId!==currentChatId){
      unreadCounts[chatId]=(unreadCounts[chatId]||0)+1;
      loadUsers();
    }
  });
}
</script>
</head>
<body></body>
</html>
